# MCP OAuth 2.1 プロバイダー非依存アーキテクチャ概要

このドキュメントでは、MCP OAuth 2.1実装のアーキテクチャについて説明します。この例ではAWS Cognitoを認証サーバーとして使用していますが、実装は**プロバイダー非依存**で、任意のOAuth 2.1準拠認証サーバーで動作します。

## システムアーキテクチャ

この実装は、最新のMCP認証仕様で定義されているMCPサーバー（リソースサーバー）と認証サーバーの明確な分離に基づいています。重要な革新点は、すべての発見と検証がハードコードされたプロバイダー固有のロジックなしに動的に行われることです。

## コンポーネント

### 1. MCPクライアント (Express.js)

以下を実装するNode.js Expressアプリケーション:
- Protected Resource Metadataを通じた認証サーバーの**動的**発見
- プロバイダー非依存のOAuth 2.1認証コードフロー（PKCE付き）
- トークン管理（保存、更新など）
- MCPサーバーへの認証済みAPIコール

クライアントは以下のプロセスに従います:
1. MCPサーバーに初期リクエストを作成
2. リソースメタデータを指すWWW-Authenticateヘッダーを含む401を受信
3. リソースメタデータを取得して認証サーバーURLを発見
4. 発見されたURLから認証サーバーメタデータを**動的に取得**
5. 発見されたエンドポイントを使用してOAuthフローを開始（セキュリティのためPKCE付き）
6. トークンを受信し保存
7. 認証済みリクエストでアクセストークンを使用

### 2. MCPサーバー (リソースサーバー, Express.js)

Express.jsを使用して実装:
- `/.well-known/oauth-protected-resource`でProtected Resource Metadataドキュメントを提供
- `/.well-known/oauth-authorization-server`で**一般的なOAuth認証サーバーメタデータを公開**（バッキングプロバイダーにプロキシ）
- 発見されたJWKS URIと発行者情報を使用してアクセストークンを**動的に検証**
- 未認証リクエストに対して適切なWWW-Authenticateヘッダーを含む401を返す
- 保護されたリソースとしてMCP APIエンドポイントを提供

### 3. 認証サーバー (この例ではAWS Cognito)

OAuth 2.1認証サーバーとして機能（任意の準拠プロバイダーを使用可能）:
- ユーザー認証と認可を管理
- アクセストークンとリフレッシュトークンを発行
- 適切なクレームを持つJWTトークンを提供
- PKCEを使用した認証コードフローをサポート
- **注記**: Cognitoを例として使用していますが、任意のOAuth 2.1準拠認証サーバーで置き換え可能

### 4. 自動発見クライアント (Express.js)

以下を追加するMCPクライアントの派生版:
- OAuth 2.1 Dynamic Client Registrationサポート
- 事前設定なしの**完全な自動発見フロー**
- DCRエンドポイント（この例ではAPI Gateway）への登録
- 動的に取得した認証情報を使用するOAuthフロー
- **完全にプロバイダー非依存** - DCRをサポートする任意のOAuthサーバーで動作

### 5. Dynamic Client Registration API (API Gateway + Lambda)

Dynamic Client Registrationのバックエンドを提供:
- クライアント登録用API Gatewayエンドポイント
- Cognitoアプリクライアントを作成するLambda関数
- 登録情報を保存するDynamoDBテーブル
- スケーラブルなクライアント登録のためのサーバーレスアーキテクチャ

### CognitoとDynamic Client Registration

MCP仕様ではDynamic Client Registration (DCR)のサポートを推奨していますが、AWS CognitoはOAuth 2.0 DCRプロトコル（RFC7591）をネイティブ実装していません。この制限に対処するため、我々の実装では:

1. API Gatewayを使用してカスタムDCRエンドポイントをデプロイ
2. Lambda関数を使用して登録ロジックを実装
3. AWS SDKを通じてCognitoアプリクライアントをプログラム的に作成
4. 永続性のためDynamoDBに登録データを保存

このアーキテクチャにより、Cognitoの堅牢な認証機能を活用しながら、DCRのシームレスなクライアントオンボーディング利点を提供できます。本番環境では、[DCRセキュリティ推奨事項](./dcr-security-recommendations.md)で概説されているように、このDCR実装にセキュリティメカニズムを追加することを検討してください。

## 認証フロー

この実装での完全なOAuth 2.1フローは以下のように動作します:

1. **初期リクエストと発見**
   - クライアントが認証なしでMCPサーバーにリクエスト
   - サーバーが401とWWW-Authenticateヘッダーでレスポンス
   - クライアントがヘッダーからリソースメタデータURLを抽出
   - クライアントがProtected Resource Metadataドキュメントを取得
   - クライアントがメタデータから認証サーバーURLを発見

2. **認証**
   - クライアントがPKCEコード検証者とチャレンジを生成
   - クライアントがユーザーをCognito認証エンドポイントにリダイレクト
   - ユーザーがCognitoで認証
   - Cognitoが認証コードでクライアントにリダイレクト

3. **トークン交換**
   - クライアントが認証コード + コード検証者をトークンと交換
   - Cognitoがアクセストークン、IDトークン、リフレッシュトークンを発行
   - クライアントがトークンを安全に保存

4. **認証済みリクエスト**
   - クライアントがAuthorizationヘッダーにアクセストークンを含める
   - MCPサーバーがCognitoでトークンを検証
   - 有効な場合、サーバーがリクエストを処理し保護されたリソースを返す
   - 無効な場合、サーバーがWWW-Authenticateヘッダーを含む401を返す

5. **トークン更新**
   - アクセストークンが期限切れになると、クライアントがリフレッシュトークンを使用
   - クライアントがCognitoに新しいアクセストークンをリクエスト
   - クライアントが保存されたトークンを更新

## Dynamic Client Registrationフロー

Dynamic Client Registration (DCR) プロセスは以下のように動作します:

1. **クライアント初期化**
   - 自動クライアントが事前設定されたOAuth認証情報なしで開始
   - MCPサーバーURLのみがクライアントに既知

2. **MCPサーバー発見**
   - クライアントが未認証リクエストをMCPサーバーに送信
   - サーバーが401とWWW-Authenticateヘッダーでレスポンス
   - クライアントがProtected Resource Metadata (PRM)を発見

3. **認証サーバー発見**
   - クライアントがPRMから認証サーバーURLを抽出
   - クライアントがCognitoからOpenID Connect設定を取得

4. **動的登録**
   - クライアントがDCRエンドポイントに登録リクエストを送信
   - リクエストにリダイレクトURIと希望するスコープを含める
   - Lambda関数が新しいCognitoアプリクライアントを作成
   - DynamoDBが登録詳細を保存

5. **認証情報管理**
   - 登録レスポンスにclient_idとclient_secretを含める
   - クライアントがこれらの認証情報をメモリ/セッションに保存
   - 認証情報が標準OAuthフローで使用される

6. **標準OAuthフロー**
   - 動的に取得した認証情報を使用して、クライアントが
     標準OAuth 2.1認証フローを続行

## AWSリソース設定

### Cognitoユーザープール
- ユーザー管理と認証
- 認証コード許可を持つOAuthアプリクライアント
- ホストUI用ドメイン

### Express.jsサーバー設定
- OAuth 2.1発見メカニズムを実装
- Protected Resource Metadataを提供
- Cognito JWT検証を使用してトークンを検証

### API Gateway
- Dynamic Client Registration用REST APIを提供
- 登録リクエストをLambda関数にルーティング
- スケーラブルなクライアント登録機能を実現

### Lambda関数
- クライアント登録リクエストを処理
- Cognitoアプリクライアントをプログラム的に作成
- DynamoDBに登録情報を保存

### DynamoDB
- クライアント登録詳細を保存
- DCR関係の永続性を提供
- クライアント情報の検索を可能にする

## セキュリティ考慮事項

この実装はOAuth 2.1とMCPセキュリティベストプラクティスに従います:

1. **PKCE (Proof Key for Code Exchange)**
   - 認証コード傍受に対する保護
   - すべての認証コードフローで必須

2. **トークン検証**
   - JWT署名検証
   - オーディエンスと発行者の検証
   - 有効期限チェック

3. **HTTPS のみ**
   - すべてのエンドポイントでHTTPS使用
   - 安全なトークン送信

4. **短期間有効トークン**
   - アクセストークンの限定的な有効期間
   - 新しいアクセストークン取得のためのリフレッシュトークン

5. **適切な認可**
   - RFC6750に従うベアラートークン使用
   - RFC9728に従うWWW-Authenticateヘッダー

6. **Dynamic Client Registrationセキュリティ**
   - この実装は簡単のため匿名DCRを使用
   - 本番システムでは追加セキュリティを実装すべき:
     * 登録認可のための初期アクセストークン
     * 安全な登録のためのクライアント認証（mTLS）
     * 登録ポリシーと承認ワークフロー
     * 悪用防止のためのレート制限

## 図表
- [アーキテクチャ図](../mcp-oauth-architecture.mermaid)
- [シーケンス図](../mcp-oauth-sequence.mermaid)
